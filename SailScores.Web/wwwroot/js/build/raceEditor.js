"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.init=init,exports.loadSeriesOptions=loadSeriesOptions,exports.loadFleet=loadFleet,exports.raceStateChanged=raceStateChanged,exports.completeCompCreate=completeCompCreate,exports.completeCompCreateFailed=completeCompCreateFailed,exports.hideAlert=hideAlert,exports.moveUp=moveUp,exports.moveDown=moveDown,exports.deleteResult=deleteResult,exports.confirmDelete=confirmDelete,exports.hideScoreButtonFooter=hideScoreButtonFooter,exports.addNewCompetitorById=addNewCompetitorById,exports.calculatePlaces=calculatePlaces;var _jquery=_interopRequireDefault(require("jquery"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}require("bootstrap"),require("bootstrap-select");var allCompetitors,competitorSuggestions,seriesOptions,noCodeString="No Code";function checkEnter(e){var t=e||event;return/textarea/i.test(t.srcElement.tagName)||13!==(e.keyCode||e.which||e.charCode||0)}function init(){document.querySelector("form").onkeypress=checkEnter,(0,_jquery.default)("#raceform").submit((function(e){e.preventDefault();addScoresFieldsToForm(this),this.submit(),removeScoresFieldsFromForm(this)})),loadFleet(),loadSeriesOptions(),calculatePlaces(),(0,_jquery.default)("#submitButton").prop("disabled",!1),(0,_jquery.default)("#submitDisabledMessage").prop("hidden",!0)}function loadSeriesOptions(){getSeries((0,_jquery.default)("#clubId").val(),(0,_jquery.default)("#date").val())}function loadFleet(){var e=(0,_jquery.default)("#clubId").val(),t=(0,_jquery.default)("#fleetId").val(),o=document.getElementById("fleetId"),r=o.options[o.selectedIndex].getAttribute("data-boat-class-id");r&&(0,_jquery.default)("#createCompBoatClassSelect").val(r),(0,_jquery.default)("#createCompFleetId").val(t),getCompetitors(e,t)}function raceStateChanged(){var e=(0,_jquery.default)("#raceState").val();"2"===e&&clearWeatherFields(),"1"===e&&populateEmptyWeatherFields()}function completeCompCreate(){getCompetitors((0,_jquery.default)("#clubId").val(),(0,_jquery.default)("#fleetId").val()),(0,_jquery.default)("#createCompetitor").modal("hide")}function completeCompCreateFailed(){(0,_jquery.default)("#compCreateAlert").show()}function hideAlert(){(0,_jquery.default)("#compCreateAlert").hide()}function moveUp(){var e=event.target,t=(0,_jquery.default)(e).closest("li");t.prev().insertAfter(t),calculatePlaces()}function moveDown(){var e=event.target,t=(0,_jquery.default)(e).closest("li");t.next().insertBefore(t),calculatePlaces()}function deleteResult(){var e=(0,_jquery.default)("#deleteConfirm"),t=e.find("#compIdToDelete").val();(0,_jquery.default)("#results").find("[data-competitorid='".concat(t,"']")).remove(),calculatePlaces(),e.modal("hide")}function confirmDelete(){var e=event.target,t=(0,_jquery.default)(e).closest("li"),o=t.data("competitorid"),r=t.find(".competitor-name").text(),a=(0,_jquery.default)("#deleteConfirm");a.find("#competitorNameToDelete").text(r),a.find("#compIdToDelete").val(o),a.show()}function hideScoreButtonFooter(){(0,_jquery.default)("#scoreButtonFooter").hide()}function addNewCompetitorById(e){addNewCompetitor(allCompetitors.find((function(t){return t.id===e})))}function addNewCompetitor(e){var t=document.getElementById("results"),o=document.getElementById("competitorTemplate").cloneNode(!0);o.id=e.id.toString(),o.setAttribute("data-competitorId",e.id.toString());var r=o.getElementsByClassName("competitor-name")[0];r.appendChild(document.createTextNode(e.name)),(r=o.getElementsByClassName("sail-number")[0]).appendChild(document.createTextNode(e.sailNumber)),e.alternativeSailNumber&&((r=o.getElementsByClassName("alt-sail-number")[0]).appendChild(document.createTextNode(" ("+e.alternativeSailNumber+")")),r.style.display=""),(r=o.getElementsByClassName("race-place")[0]).appendChild(document.createTextNode((0).toString()));for(var a=o.getElementsByClassName("delete-button"),l=0;l<a.length;l++)a[l].setAttribute("data-competitorId",e.id.toString());o.style.display="",t.appendChild(o),calculatePlaces(),(0,_jquery.default)("html, body").animate({scrollTop:(0,_jquery.default)(o).offset().top-150},300),(0,_jquery.default)("#newCompetitor").val(""),initializeAutoComplete(),updateButtonFooter()}function addScoresFieldsToForm(e){for(var t=document.getElementById("results").getElementsByTagName("li"),o=1;o<t.length;o++){var r=(o-1).toString(),a=document.createElement("input");a.type="hidden",a.name="Scores["+r+"].competitorId",a.value=t[o].getAttribute("data-competitorId"),e.appendChild(a),(a=document.createElement("input")).type="hidden",a.name="Scores["+r+"].place",shouldCompKeepScore(t[o])&&(a.value=t[o].getAttribute("data-place")),e.appendChild(a),(a=document.createElement("input")).type="hidden",a.name="Scores["+r+"].code",a.value=getCompetitorCode(t[o]),e.appendChild(a),(a=document.createElement("input")).type="hidden",a.name="Scores["+r+"].codePointsString",a.value=getCompetitorCodePoints(t[o]),e.appendChild(a)}}function removeScoresFieldsFromForm(e){e.find("[name^=Scores]").remove()}function calculatePlaces(){for(var e=document.getElementById("results").getElementsByTagName("li"),t=1,o=1,r=e.length;o<r;o++){var a=e[o].getElementsByClassName("race-place")[0];e[o].setAttribute("data-place",o.toString());var l=e[o].getAttribute("data-originalScore");"competitorTemplate"!==a.id&&(shouldCompKeepScore(e[o])&&"0"!==l?(a.textContent=t.toString(),e[o].setAttribute("data-place",t.toString()),t++):(a.textContent=getCompetitorCode(e[o]),e[o].removeAttribute("data-place")));var n=e[o].getElementsByClassName("code-points")[0];shouldHaveManualEntry(e[o])?n.style.display="":(n.style.display="none",n.value="")}}function competitorIsInResults(e){for(var t=document.getElementById("results").getElementsByTagName("li"),o=0,r=t.length;o<r;o++)if(t[o].getAttribute("data-competitorId")===e.id.toString())return!0;return!1}function getSuggestions(){var e=[];return console.debug("checking for comps in results"),allCompetitors.forEach((function(t){if(!competitorIsInResults(t)){var o={value:t.sailNumber+" - "+t.name,data:t};t.alternativeSailNumber&&(o.value=t.sailNumber+" ( "+t.alternativeSailNumber+" ) - "+t.name),e.push(o)}})),e}function getCompetitors(e,t){e&&t&&_jquery.default.getJSON("/api/Competitors",{clubId:e,fleetId:t},(function(e){allCompetitors=e,initializeAutoComplete(),initializeButtonFooter()}))}function getSeries(e,t){e&&t&&_jquery.default.getJSON("/api/Series",{clubId:e,date:t},(function(e){seriesOptions=e,setSeries()}))}function setSeries(){var e=(0,_jquery.default)("#seriesIds"),t=e.val();e.empty(),_jquery.default.each(seriesOptions,(function(t,o){var r=o;e.append((0,_jquery.default)("<option></option>").attr("value",r.id.toString()).text(r.name))})),e.selectpicker("destroy"),e.selectpicker(),e.val(t),e.selectpicker("refresh")}var autoCompleteSetup=!1;function initializeAutoComplete(){competitorSuggestions=getSuggestions(),autoCompleteSetup&&(0,_jquery.default)("#newCompetitor").autocomplete().dispose(),(0,_jquery.default)("#newCompetitor").autocomplete({lookup:competitorSuggestions,onSelect:function(e){addNewCompetitor(e.data)},autoSelectFirst:!0,triggerSelectOnValidInput:!1,noCache:!0}),autoCompleteSetup=!0}function initializeButtonFooter(){(0,_jquery.default)("#scoreButtonDiv").empty(),allCompetitors&&allCompetitors.length&&allCompetitors.length<21?(0,_jquery.default)("#scoreButtonFooter").show():(0,_jquery.default)("#scoreButtonFooter").hide(),allCompetitors.forEach((function(e){var t="btn ",o="";competitorIsInResults(e)?t+="btn-primary":(t+="btn-outline-primary",o="window.SailScores.addNewCompetitorById('"+e.id+"')"),(0,_jquery.default)("#scoreButtonDiv").append('<button class="'+t+' data-id="'+e.id+'" onclick="'+o+'" > '+(e.sailNumber||e.alternativeSailNumber)+" </button>")}))}function updateButtonFooter(){(0,_jquery.default)("#scoreButtonDiv").empty(),allCompetitors.forEach((function(e){var t="btn ",o="";competitorIsInResults(e)?t+="btn-primary":(t+="btn-outline-primary",o="window.SailScores.addNewCompetitorById('"+e.id+"')"),(0,_jquery.default)("#scoreButtonDiv").append('<button class="'+t+' data-id="'+e.id+'" onclick="'+o+'" > '+(e.sailNumber||e.alternativeSailNumber)+" </button>")}))}function getCompetitorCode(e){var t=e.getElementsByClassName("select-code")[0].value;return t===noCodeString?null:t}function getCompetitorCodePoints(e){var t=e.getElementsByClassName("code-points")[0].value;return t===noCodeString?null:t}function shouldCompKeepScore(e){var t=e.getElementsByClassName("select-code")[0].value;return t===noCodeString||!!scoreCodes.filter((function(e){return e.name===t}))[0].preserveResult}function shouldHaveManualEntry(e){var t=e.getElementsByClassName("select-code")[0].value;return t!==noCodeString&&"MAN"===scoreCodes.filter((function(e){return e.name===t}))[0].formula}function clearWeatherFields(){(0,_jquery.default)("#weatherIcon").val("Select..."),(0,_jquery.default)("#weatherIcon").selectpicker("refresh"),(0,_jquery.default)("#weatherDescription").val(null),(0,_jquery.default)("#windSpeed").val(null),(0,_jquery.default)("#windGust").val(null),(0,_jquery.default)("#windDirection").val(null),(0,_jquery.default)("#temperature").val(null),(0,_jquery.default)("#humidity").val(null),(0,_jquery.default)("#cloudcover").val(null)}function populateEmptyWeatherFields(){var e=(0,_jquery.default)("#clubInitials").val();_jquery.default.getJSON("/"+e+"/weather/current/",{},(function(e){console.log(e),e.icon&&(0,_jquery.default)("#weatherIcon").val(null)&&((0,_jquery.default)("#weatherIcon").val(e.icon),(0,_jquery.default)("#weatherIcon").selectpicker("refresh")),e.description&&(0,_jquery.default)("#weatherDescription").val(null)&&(0,_jquery.default)("#weatherDescription").val(e.description),e.windSpeed&&(0,_jquery.default)("#windSpeed").val(null)&&(0,_jquery.default)("#windSpeed").val(e.windSpeed),e.windGust&&(0,_jquery.default)("#windGust").val(null)&&(0,_jquery.default)("#windGust").val(e.windGust),e.windDirection&&(0,_jquery.default)("#windDirection").val(null)&&(0,_jquery.default)("#windDirection").val(e.windDirection),e.temperature&&(0,_jquery.default)("#temperature").val(null)&&(0,_jquery.default)("#temperature").val(e.temperature),e.humidity&&(0,_jquery.default)("#humidity").val(null)&&(0,_jquery.default)("#humidity").val(e.humidity),e.cloudCoverPercent&&(0,_jquery.default)("#cloudCover").val(null)&&(0,_jquery.default)("#cloudCover").val(e.cloudCoverPercent)}))}