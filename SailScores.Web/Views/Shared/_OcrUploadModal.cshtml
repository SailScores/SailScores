@* OCR Photo Upload Modal *@
<div class="modal fade" id="ocrUploadModal" tabindex="-1" aria-labelledby="ocrUploadModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">

            <style>
                /* Prevent layout shift when drawing overlays by hiding overflow
                   and ensuring the image and canvas behave as block-level elements */
                .ocr-cropped-preview { position: relative; overflow: hidden; }
                .ocr-cropped-preview img { display: block; max-width: 100%; height: auto; }
                #ocrBoundingBoxOverlay { position: absolute; left: 0; top: 0; pointer-events: none; width: 100%; height: 100%; display: block; }
            </style>

            <div class="modal-header">
                <h5 class="modal-title" id="ocrUploadModalLabel">Add Results from Photo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                @* Alert container *@
                <div id="ocrAlertContainer"></div>

                @* Progress bar *@
                <div class="progress mb-3 d-none d-md-block" style="height: 4px;">
                    <div class="progress-bar" id="ocrProgressBar" role="progressbar" style="width: 25%"></div>
                </div>

                @* Step 1: Upload *@
                <div id="ocrStepUpload" class="ocr-step d-block">
                    <div class="text-center p-3">
                        <i class="fas fa-camera fa-4x text-primary mb-3"></i>
                        <h5>Upload or Capture Photo</h5>
                        <p class="text-muted">You can trim the image in the next step.</p>

                        <div class="d-grid gap-2 col-md-6 mx-auto">
                            <input type="file" id="ocrFileInput" accept="image/*" class="d-none" />
                            <button type="button" class="btn btn-primary" id="ocrCameraButton">
                                <i class="fas fa-camera"></i> Take Photo
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="$('#ocrFileInput').click()">
                                <i class="fas fa-upload"></i> Select File
                            </button>
                        </div>

                        <div class="mt-4">
                            <small class="text-muted">
                                <strong>Tips:</strong>
                                <ul class="text-start text-md-center ocr-tip-list">
                                    <li>Align the results vertically</li>
                                    <li>Ensure good lighting and focus</li>
                                    <li>Position camera straight above the results</li>
                                    <li>Make sure sail numbers are clearly visible</li>
                                </ul>
                            </small>
                        </div>
                    </div>
                </div>

                @* Step 2: Crop *@
                <div id="ocrStepCrop" class="ocr-step d-none">
                    <div class="mb-1">
                        <p class="text-muted">Adjust the edges to include only the sail numbers for this race.</p>
                    </div>

                    <div class="cropper-container-wrapper p-0">
                        <img id="ocrImage" style="max-width: 100%;" />
                    </div>
                </div>

                @* Step 3: Processing *@
                <div id="ocrStepProcessing" class="ocr-step d-none">
                    <div class="text-center p-5">
                        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">Processing...</span>
                        </div>
                        <h5>Processing Image...</h5>
                        <p class="text-muted" id="ocrProcessingStatus">Preparing image...</p>
                    </div>
                </div>

                @* Step 4: Results *@
                <div id="ocrStepResults" class="ocr-step d-none">
                    <div class="row">
                        @* Left column: Cropped Image - Collapsible on small screens *@
                        <div class="col-md-4">
                            <div class="mb-3">
                                <h6>
                                    <a class="d-md-none" data-bs-toggle="collapse" href="#ocrImagePreviewCollapse" role="button" aria-expanded="false" aria-controls="ocrImagePreviewCollapse">
                                        <span class="chevron"><i class="fas fa-chevron-right"></i></span> Cropped Image
                                    </a>
                                    <span class="d-none d-md-inline"> Image</span>
                                </h6>
                                <p class="text-muted small d-none d-md-block">Cropped Image</p>
                            </div>
                            <div class="collapse d-md-block" id="ocrImagePreviewCollapse">
                                <div class="ocr-cropped-preview">
                                    <img id="ocrCroppedImagePreview" src="" alt="Cropped image" class="img-fluid" />
                                    <canvas id="ocrBoundingBoxOverlay"></canvas>
                                </div>
                            </div>
                        </div>

                        @* Right column: OCR Results Table *@
                        <div class="col-md-8">
                            <div class="mb-3">
                                <h6>OCR Results <span class="badge bg-primary" id="ocrMatchCount">0 matched</span></h6>
                                <p class="text-muted small d-none d-md-block">
                                    Confirm the detected sail numbers
                                </p>
                            </div>

                            <div class="table-responsive" style="overflow-y: auto;">
                            <div class="table-responsive ocr-results-container">
                                <table class="table table-sm table-hover" id="ocrResultsTable">
                                    <thead class="sticky-top">
                                        <tr>
                                            <th style="width: 40px;"></th>
                                            <th>Line</th>
                                            <th>Sail</th>
                                            <th>Competitor</th>
                                            <th>
                                                <span class="d-none d-lg-inline">Confidence</span>
                                                <span class="d-inline d-lg-none">Conf.</span>
                                            </th>
                                            <th style="width: 40px;">
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @* Results populated by JavaScript *@
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                @* Upload step footer *@
                <div id="ocrFooterUpload" class="ocr-step-footer w-100">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>

                @* Crop step footer *@
                <div id="ocrFooterCrop" class="ocr-step-footer w-100 d-none">
                    <button type="button" class="btn btn-secondary" id="ocrBackToUploadButton">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <button type="button" class="btn btn-primary" id="ocrProcessButton">
                        <i class="fas fa-magic"></i> Read
                    </button>
                </div>

                @* Processing step footer *@
                <div id="ocrFooterProcessing" class="ocr-step-footer w-100 d-none">
                    <button type="button" class="btn btn-secondary" disabled>Please wait...</button>
                </div>

                @* Results step footer *@
                <div id="ocrFooterResults" class="ocr-step-footer w-100 d-none">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="ocrAddSelectedButton">
                        <i class="fas fa-check-square"></i> Add Selected
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

